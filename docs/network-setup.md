# ネットワーク設定ガイド

このガイドでは、インターネットからDS224j上のWebサイトにアクセスできるようにするための設定を説明します。

---

## 概要

インターネットからアクセスできるようにするには、以下の設定が必要です:

1. **ポートフォワーディング**: ルーターがインターネットからの通信をDS224jに転送する設定
2. **DDNS(Dynamic DNS)**: IPアドレスが変わっても、ドメイン名でアクセスできるようにする設定

---

## ステップ1: 現在のネットワーク情報を確認

### DS224jのIPアドレスを確認

1. DSMにログイン
2. **「コントロールパネル」** → **「ネットワーク」** → **「ネットワークインターフェース」** を開く
3. **LAN** の項目で、IPアドレスを確認(例: `192.168.1.100`)
4. このIPアドレスをメモしておく

### 外部IPアドレスを確認

1. Webブラウザで <https://www.cman.jp/network/support/go_access.cgi> にアクセス
2. 表示された「あなたのIPアドレス」をメモ
3. 数時間後に再度アクセスして、IPアドレスが変わっているか確認
   - **変わらない場合**: 固定IP(設定が簡単)
   - **変わる場合**: 動的IP(DDNSが必要)

---

## ステップ2: ルーターのポートフォワーディング設定

### ルーターの管理画面にアクセス

一般的なルーターの管理画面アドレス:

- `http://192.168.1.1`
- `http://192.168.0.1`
- `http://192.168.11.1` (Buffalo製ルーター)

> **💡 ヒント**: ルーターの背面や底面にシールで記載されていることが多いです。

### ポートフォワーディングの設定

ルーターによって設定画面が異なりますが、一般的な手順:

1. ルーターの管理画面にログイン
2. **「詳細設定」** または **「高度な設定」** を探す
3. **「ポートフォワーディング」** または **「仮想サーバー」** または **「NAT設定」** を開く
4. 以下の3つのルールを追加:

#### ルール1: HTTP (ポート80)

- **サービス名**: `EDINET-HTTP`
- **外部ポート**: `80`
- **内部IPアドレス**: `DS224jのIPアドレス` (例: 192.168.1.100)
- **内部ポート**: `80`
- **プロトコル**: `TCP`

#### ルール2: HTTPS (ポート443)

- **サービス名**: `EDINET-HTTPS`
- **外部ポート**: `443`
- **内部IPアドレス**: `DS224jのIPアドレス`
- **内部ポート**: `443`
- **プロトコル**: `TCP`

#### ルール3: Nginx Proxy Manager管理画面 (ポート81) - オプション

- **サービス名**: `NPM-Admin`
- **外部ポート**: `81`
- **内部IPアドレス**: `DS224jのIPアドレス`
- **内部ポート**: `81`
- **プロトコル**: `TCP`

> **⚠️ セキュリティ注意**: ポート81は管理画面なので、設定完了後は無効化することをお勧めします。

1. 設定を保存して、ルーターを再起動(必要な場合)

### 主要ルーターメーカー別の設定方法

#### Buffalo製ルーター

1. 「詳細設定」→「セキュリティ」→「ポートフォワーディング」
2. 「新規追加」で上記のルールを追加

#### NEC製ルーター(Aterm)

1. 「詳細設定」→「ポートマッピング設定」
2. 「エントリ追加」で上記のルールを追加

#### TP-Link製ルーター

1. 「転送」→「仮想サーバー」
2. 「追加」で上記のルールを追加

---

## ステップ3: DS224jのIPアドレスを固定化

ルーターがDS224jに毎回同じIPアドレスを割り当てるように設定します。

### 方法1: DS224j側で固定IPを設定(推奨)

1. DSMの **「コントロールパネル」** → **「ネットワーク」** → **「ネットワークインターフェース」** を開く
2. **LAN** をダブルクリック
3. **「IPv4」** タブを選択
4. **「手動で設定」** を選択
5. 以下を入力:
   - **IPアドレス**: 現在のIPアドレス(例: `192.168.1.100`)
   - **サブネットマスク**: `255.255.255.0`
   - **ゲートウェイ**: ルーターのIPアドレス(例: `192.168.1.1`)
   - **DNSサーバー**: `8.8.8.8` (GoogleのDNS)
6. **「OK」** をクリック

### 方法2: ルーター側でDHCP予約を設定

1. ルーターの管理画面にログイン
2. **「DHCP設定」** または **「LAN設定」** を開く
3. **「DHCPアドレス予約」** または **「MACアドレス予約」** を探す
4. DS224jのMACアドレスに対して、現在のIPアドレスを予約

---

## ステップ4: DDNS設定(動的IPの場合)

### Synology DDNSを使用(無料・推奨)

1. DSMの **「コントロールパネル」** → **「外部アクセス」** → **「DDNS」** を開く
2. **「追加」** ボタンをクリック
3. 以下を設定:
   - **サービスプロバイダー**: `Synology`
   - **ホスト名**: 好きな名前を入力(例: `myedinet`)
   - **完全なドメイン名**: `myedinet.synology.me` (自動表示)
   - **外部アドレス(IPv4)**: 自動取得
4. **「OK」** をクリック
5. ステータスが **「正常」** になることを確認

これで、`https://myedinet.synology.me` でアクセスできるようになります!

### その他の無料DDNSサービス

#### No-IP

1. <https://www.noip.com/> でアカウント作成
2. 無料ホスト名を作成(例: `myedinet.ddns.net`)
3. DSMの **「コントロールパネル」** → **「外部アクセス」** → **「DDNS」** で設定:
   - **サービスプロバイダー**: `No-IP.com`
   - **ホスト名**: 作成したホスト名
   - **ユーザー名/パスワード**: No-IPのアカウント情報

#### DuckDNS

1. <https://www.duckdns.org/> にアクセス
2. Googleアカウントなどでログイン
3. ドメイン名を作成(例: `myedinet.duckdns.org`)
4. トークンをコピー
5. DSMの **「コントロールパネル」** → **「外部アクセス」** → **「DDNS」** で設定:
   - **サービスプロバイダー**: `DuckDNS`
   - **ホスト名**: 作成したドメイン名
   - **ユーザー名/パスワード**: トークンを入力

---

## ステップ5: 動作確認

### 内部ネットワークからの確認

1. DS224jと同じWi-Fiに接続されたPCやスマホから
2. `http://DS224jのIPアドレス:81` にアクセス
3. Nginx Proxy Managerの管理画面が表示されればOK

### 外部ネットワークからの確認

1. スマートフォンのモバイル回線(Wi-Fiをオフ)から
2. 以下のいずれかにアクセス:
   - 固定IPの場合: `http://外部IPアドレス:81`
   - DDNSの場合: `http://設定したドメイン名:81`
3. Nginx Proxy Managerの管理画面が表示されればOK

> **⚠️ 注意**: まだHTTPSではないので、ブラウザに警告が表示される場合があります。次のステップでSSL証明書を設定します。

---

## トラブルシューティング

### 外部からアクセスできない

1. **ポートフォワーディングの確認**
   - ルーターの設定を再確認
   - DS224jのIPアドレスが正しいか確認

2. **ファイアウォールの確認**
   - DSMの **「コントロールパネル」** → **「セキュリティ」** → **「ファイアウォール」**
   - ポート80, 443, 81が許可されているか確認

3. **ISPの制限確認**
   - 一部のインターネットプロバイダーはポート80/443をブロックしています
   - その場合は、別のポート(例: 8080, 8443)を使用する必要があります

### DDNSが更新されない

1. DSMの **「コントロールパネル」** → **「外部アクセス」** → **「DDNS」** でステータスを確認
2. **「今すぐ更新」** ボタンをクリック
3. エラーメッセージがあれば、ユーザー名/パスワードを再確認

---

## 次のステップ

ネットワーク設定が完了したら、次のガイドに進んでください:

1. [SSL証明書とドメイン設定ガイド](./ssl-domain-setup.md) - HTTPS化してセキュアにアクセス
2. [アクセス制限設定ガイド](./access-control.md) - 知人だけがアクセスできるように制限
