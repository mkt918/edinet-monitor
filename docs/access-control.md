# アクセス制限設定ガイド

このガイドでは、自分と知人だけがWebサイトにアクセスできるようにするためのセキュリティ設定を説明します。

---

## アクセス制限の方法

以下の3つの方法があります:

1. **Basic認証**: ユーザー名とパスワードでアクセス制限(最も簡単)
2. **IPアドレス制限**: 特定のIPアドレスからのみアクセス許可
3. **VPN経由アクセス**: DS224jのVPN機能を使用(最も安全)

---

## 方法1: Basic認証の設定(推奨)

### ステップ1: Access Listの作成

1. Nginx Proxy Manager管理画面にログイン
2. 上部メニューの **「Access Lists」** をクリック
3. **「Add Access List」** ボタンをクリック
4. **「Details」** タブで以下を入力:
   - **Name**: `EDINET認証` (任意の名前)
   - **Satisfy Any**: チェックを外す(すべての条件を満たす必要がある)

### ステップ2: 認証情報の追加

1. **「Authorization」** タブをクリック
2. **「Username」** と **「Password」** を入力
   - 例: Username: `edinet_user`, Password: `強力なパスワード`
3. 複数のユーザーを追加する場合は、**「Add」** ボタンで追加
4. **「Save」** ボタンをクリック

### ステップ3: プロキシホストにAccess Listを適用

1. **「Proxy Hosts」** タブに戻る
2. EDINET監視アプリのプロキシホストを編集(鉛筆アイコンをクリック)
3. **「Details」** タブで、**「Access List」** ドロップダウンから先ほど作成した `EDINET認証` を選択
4. **「Save」** をクリック

### 動作確認

1. `https://DDNSドメイン名` にアクセス
2. ユーザー名とパスワードの入力画面が表示されることを確認
3. 正しい認証情報を入力すると、サイトが表示されることを確認

---

## 方法2: IPアドレス制限

特定のIPアドレスからのみアクセスを許可する方法です。

### 固定IPを持つ知人のみに公開する場合

1. **「Access Lists」** で新しいリストを作成
2. **「Access」** タブをクリック
3. **「Allow」** セクションに許可するIPアドレスを追加:
   - 例: `203.0.113.10` (知人AのIP)
   - 例: `198.51.100.20` (知人BのIP)
4. **「Deny」** セクションに `all` を追加(すべてのIPを拒否)
5. **「Save」** をクリック
6. プロキシホストにこのAccess Listを適用

> **⚠️ 注意**: 動的IPアドレスの場合、IPが変わるたびに設定を更新する必要があります。

### IPアドレス範囲で制限

特定のネットワーク範囲を許可する場合:

- 例: `192.168.1.0/24` (192.168.1.1〜192.168.1.254を許可)
- 例: `10.0.0.0/8` (10.0.0.0〜10.255.255.255を許可)

---

## 方法3: VPN経由でのアクセス(最も安全)

DS224jのVPN機能を使用して、VPN接続した人だけがアクセスできるようにします。

### ステップ1: VPN Serverのインストール

1. DSMの **「パッケージセンター」** を開く
2. **「VPN Server」** を検索してインストール
3. インストール完了後、**「開く」** をクリック

### ステップ2: VPNプロトコルの設定

#### OpenVPN(推奨)

1. **「OpenVPN」** タブを選択
2. **「OpenVPN サーバーを有効にする」** にチェック
3. 以下を設定:
   - **ポート**: `1194` (デフォルト)
   - **最大接続数**: `10` (知人の数に応じて)
   - **動的IPアドレス**: `10.8.0.0/24`
4. **「適用」** をクリック

#### L2TP/IPSec(iPhoneなどで簡単に接続)

1. **「L2TP/IPSec」** タブを選択
2. **「L2TP/IPSec VPN サーバーを有効にする」** にチェック
3. **「事前共有キー」** を設定(強力なパスワード)
4. **「適用」** をクリック

### ステップ3: VPNユーザーの作成

1. **「権限」** タブをクリック
2. アクセスを許可するユーザーにチェックを入れる
3. または、DSMの **「コントロールパネル」** → **「ユーザー」** で新しいユーザーを作成

### ステップ4: VPN設定ファイルのエクスポート(OpenVPNの場合)

1. **「OpenVPN」** タブで **「設定ファイルをエクスポート」** をクリック
2. ダウンロードしたファイルを知人に送付

### ステップ5: クライアント側の設定

#### Windows

1. OpenVPN GUIをインストール: <https://openvpn.net/community-downloads/>
2. 設定ファイル(.ovpn)を `C:\Program Files\OpenVPN\config\` にコピー
3. OpenVPN GUIを起動して接続

#### Mac

1. Tunnelblickをインストール: <https://tunnelblick.net/>
2. 設定ファイルをダブルクリックしてインポート
3. 接続

#### iPhone/Android

1. **OpenVPN Connect** アプリをインストール
2. 設定ファイルをインポート
3. 接続

### ステップ6: ポートフォワーディングの変更

VPN接続した人だけがアクセスできるようにするため:

1. ルーターのポートフォワーディング設定で、**ポート80と443のルールを削除**
2. VPN用のポートを追加:
   - **外部ポート**: `1194` (OpenVPNの場合)
   - **内部IPアドレス**: DS224jのIPアドレス
   - **内部ポート**: `1194`
   - **プロトコル**: `UDP`

これで、VPN接続しないとWebサイトにアクセスできなくなります。

---

## 方法4: Basic認証 + IPアドレス制限の併用(最も強力)

より強固なセキュリティのため、Basic認証とIPアドレス制限を併用できます。

1. **「Access Lists」** で新しいリストを作成
2. **「Authorization」** タブでBasic認証を設定
3. **「Access」** タブで許可するIPアドレスを設定
4. **「Satisfy Any」** のチェックを外す(両方の条件を満たす必要がある)

---

## セキュリティのベストプラクティス

### 1. 強力なパスワードを使用

- 最低12文字以上
- 大文字、小文字、数字、記号を組み合わせる
- パスワード生成ツールを使用: <https://www.lastpass.com/features/password-generator>

### 2. 定期的なパスワード変更

- 3〜6ヶ月ごとにパスワードを変更
- 知人が増えた場合は、個別のアカウントを作成

### 3. ログの監視

1. Nginx Proxy Managerの **「Audit Log」** を定期的に確認
2. 不審なアクセスがないかチェック

### 4. ファイアウォールの設定

DSMの **「コントロールパネル」** → **「セキュリティ」** → **「ファイアウォール」** で:

- 不要なポートを閉じる
- 特定の国からのアクセスをブロック(オプション)

### 5. 2段階認証の有効化

DSMの管理者アカウントに2段階認証を設定:

1. **「コントロールパネル」** → **「ユーザー」** → **「詳細設定」**
2. **「2段階認証を有効にする」** にチェック

---

## トラブルシューティング

### Basic認証が表示されない

1. ブラウザのキャッシュをクリア
2. プライベートブラウジングモードで再度アクセス
3. Nginx Proxy Managerのログを確認:

   ```bash
   sudo docker-compose logs nginx-proxy-manager
   ```

### パスワードを忘れた

1. Nginx Proxy Manager管理画面にログイン
2. **「Access Lists」** で該当のリストを編集
3. 新しいパスワードを設定

### VPN接続できない

1. **ポートフォワーディングの確認**
   - VPNポート(1194など)が正しく転送されているか

2. **ファイアウォールの確認**
   - DSMのファイアウォールでVPNポートが許可されているか

3. **ログの確認**
   - DSMの **「ログセンター」** でVPN関連のエラーを確認

---

## 知人へのアクセス方法の共有

### Basic認証の場合

知人に以下の情報を伝えます:

```
【EDINET監視アプリへのアクセス方法】

URL: https://myedinet.synology.me
ユーザー名: edinet_user
パスワード: ************

※パスワードは安全に保管してください
※他の人には共有しないでください
```

### VPN接続の場合

知人に以下を送付します:

1. OpenVPN設定ファイル(.ovpn)
2. 接続手順書:

```
【VPN接続手順】

1. OpenVPN Connectアプリをインストール
   - Windows: https://openvpn.net/community-downloads/
   - iPhone/Android: App StoreまたはGoogle Playで「OpenVPN Connect」を検索

2. 添付の設定ファイル(.ovpn)をインポート

3. VPN接続を開始

4. 接続後、以下のURLにアクセス:
   http://10.8.0.1:3000
   (VPN内部のIPアドレス)
```

---

## まとめ

| 方法 | 難易度 | セキュリティ | おすすめ度 |
|------|--------|--------------|------------|
| Basic認証 | ★☆☆ | ★★☆ | ★★★ |
| IPアドレス制限 | ★★☆ | ★★☆ | ★☆☆ |
| VPN経由 | ★★★ | ★★★ | ★★☆ |
| Basic認証 + IP制限 | ★★☆ | ★★★ | ★★★ |

**初心者の方には「Basic認証」がおすすめです!**

設定が簡単で、十分なセキュリティを確保できます。
